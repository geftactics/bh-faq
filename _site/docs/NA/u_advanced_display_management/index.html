<!DOCTYPE html>
<html lang="en">

    <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Begin Jekyll SEO tag v2.7.1 -->
<title>Advanced display management | Ledger Developer pages</title>
<meta name="generator" content="Jekyll v3.9.1" />
<meta property="og:title" content="Advanced display management" />
<meta name="author" content="pscott" />
<meta property="og:locale" content="en" />
<meta name="description" content="Sections in this article Introduction Cherry-picking steps at runtime Usecase Cherry-picking explained Defining steps at runtime Introduction This article talks about more advanced flows that are sometimes needed when writing applications. Cherry-picking steps at runtime Usecase The Display Management &lt;/u_display_management&gt; doc taught us how to use the UX_FLOW macro. This macro is quite handy but comes with its drawbacks: everything needs to be declared at compilation time. What if we wished to change the flow at runtime? Imagine an app where you have a flow for a transaction signature. UX_FLOW(ux_transaction_signature, &amp;step_review, &amp;step_amount, &amp;step_fee, &amp;step_address, &amp;step_accept, &amp;step_reject ); This works well enough for a transaction signature. But suppose there’s an update to the protocol: now some transactions can also sign some arbitrary data. However, not all transactions are required to sign the arbitrary data, so you need two flows: // The standard signature, nothing has changed. UX_FLOW(ux_vanilla_transaction_signature, &amp;step_review, &amp;step_amount, &amp;step_fee, &amp;step_address, &amp;step_accept, &amp;step_reject ); // This flow is almost the same as the one above, except is contains &quot;step_arbitrary_data&quot;. UX_FLOW(ux_data_transaction_signature, &amp;step_review, &amp;step_amount, &amp;step_fee, &amp;step_address, &amp;step_arbitrary_data, // Arbitrary data &amp;step_accept, &amp;step_reject ); And now somewhere in your app at runtime you will be able to decide which flow to use: void launch_flow() { if (g.has_arbitrary_data) { ux_flow_init(0, ux_data_transaction_signature, NULL); } else { ux_flow_init(0, ux_vanilla_transaction_signature, NULL); } } Great this works. Hu-oh but now the community also wants to be able to see the nonce for the transaction. But they want it to be optional. You know for advanced users. Ok so back to work: we need a flow for the vanilla signature, as well as a flow for the vanilla signature where we show the nonce. Oh but wait we also need the option to display the nonce when there is arbitrary data to sign, so we also need the “data signature” flow and the “data signature + nonce” flow. // The standard signature, nothing has changed. UX_FLOW(ux_vanilla_transaction_signature, &amp;step_review, &amp;step_amount, &amp;step_fee, &amp;step_address, &amp;step_accept, &amp;step_reject ); // Now the vanilla flow where we just add the step to display the nonce. UX_FLOW(ux_vanilla_nonce_transaction_signature, &amp;step_review, &amp;step_amount, &amp;step_fee, &amp;step_address, &amp;step_nonce, // Nonce &amp;step_accept, &amp;step_reject ); // This is identical to the previous example, where we signed some arbitrary data. UX_FLOW(ux_data_transaction_signature, &amp;step_review, &amp;step_amount, &amp;step_fee, &amp;step_address, &amp;step_arbitrary_data, // Arbitrary data &amp;step_accept, &amp;step_reject ); // This is identical to the flow just above, except we add a step to display the nonce. UX_FLOW(ux_data_nonce_transaction_signature, &amp;step_review, &amp;step_amount, &amp;step_fee, &amp;step_address, &amp;step_arbitrary_data, // Arbitrary data &amp;step_nonce, // Nonce &amp;step_accept, &amp;step_reject ); And now somewhere in our app at runtime we’re able to decide which flow to use: void launch_flow() { if (g.has_arbitrary_data) { if (g.display_nonce) { ux_flow_init(0, ux_data_nonce_transaction_signature, NULL); } else { ux_flow_init(0, ux_data_transaction_signature, NULL); } } else { if (g.display_nonce) { ux_flow_init(0, ux_vanilla_nonce_transaction_signature, NULL); } else { ux_flow_init(0, ux_vanilla_transaction_signature, NULL); } } } Ugh. Ok now everyone’s happy: we’ve updated our app to support the protocol and the advanced users in the community can display the nonce. But now a new upgrade to the protocol is planned for the near future: the fees can sometimes be paid by another user of the blockchain, called a relayer. Anyways now some transactions now need to hide the fees (displaying a fee of 0.000 is not an option because it would confuse users more than anything). So we need… 8 different flows. That escalated quickly! Indeed, for every little upgrade, we’re doubling the number of flows. Soon enough we’ll end up with 16 or even 32 different flows… Notice that whilst the number of flows will grow exponentially, the number of different steps though will only grow linearly (one for every new feature). To fix this problem, we would need to define the UX_FLOW at runtime, cherry-picking which steps we wish to include depending on the details of our transaction. Don’t worry, Ledger’s got your back! The fix is quite simple, so let’s dive right into it! Cherry-picking explained The idea is to create an array of steps that would be big enough to fit all the steps. Since steps grow linearly, this array won’t be too big. Once this array created, we simply need to fill it with the steps we wish to include. Finally, we need to add a last step FLOW_END_STEP for it to work properly. We can then call the ux_init_flow and pass in our array as argument! // The maximum number of steps we will ever need. Here it&#39;s 8: step_review, step_amount, // step_fee, step_address, step_arbitrary_data, step_nonce, step_accept, step_reject. #define MAX_NUM_STEPS 8 // The array of steps. Notice the type used, as it&#39;s important if you wish to use ux_init_flow. // We&#39;re adding `+ 1` because we need to ensure we always have extra room for the last step, FLOW_END_STEP. const ux_flow_step_t *ux_signature_flow[MAX_NUM_STEPS + 1]; void start_display() { uint8_t index = 0; // Set the first step to be `step_review`, and then increment `index`. ux_signature_flow[index++] = step_review; // Set the second step to be `step_amount`, and then increment `index`. ux_signature_flow[index++] = step_amount; // etc... ux_signature_flow[index++] = step_fee; ux_signature_flow[index++] = step_address; // We can now conditionally add steps at runtime! if (g.has_arbitrary_data) { ux_signature_flow[index++] = step_arbitrary_data; } if (g.display_nonce) { ux_signature_flow[index++] = step_nonce; } ux_signature_flow[index++] = step_accept; ux_signature_flow[index++] = step_reject; // Don&#39;t forget to finish your flow with this special step. ux_signature_flow[index++] = FLOW_END_STEP; // Start the display! ux_init_flow(0, ux_signature_flow, NULL); } Defining steps at runtime In the previous section we saw that we could define a UX_FLOW at runtime. But we did this whilst still having steps defined statically. What if we wish to define steps at runtime too? This would give us a very fine-grained control over what we wish to display, without having to declare a step everytime. Finding a step that would be generic enough to fit all our needs. Naively, the code we’d expect would look something like that: // Naive definition of a UX_FLOW. // Note: we are still keeping step_review, step_accept and // step_reject because we know our flow will need those anyway. UX_FLOW(ideal_dynamic_fow, &amp;step_welcome, &amp;step_generic, // A generic step that would fit all our needs. &amp;step_quit FLOW_LOOP ); However this wouldn’t work: if we only defined a single step, then how could it dynamically change its information? Pressing the right button would make it loop and we’d end up on the same exact screen, and pressing the left button would lead to the same situation. So here’s a solution: Add an extra step just before the step_generic step, and another one right after it. Those extra steps are nothing but delimiters for the step_generic . They allow us to execute special logic to update the screen and redisplay it. They also allow us to keep track of an index, so that we know whether we’re still within our array boundaries or not. Here’s what the code looks like. UX_FLOW(dynamic_flow, &amp;step_welcome, &amp;step_upper_delimiter, // A special step that serves as the upper delimiter. It won&#39;t print anything on the screen. &amp;step_generic, // Our generic step that will actually display stuff on the screen. &amp;step_lower_delimiter, // A special step that serves as the lower delimiter. It won&#39;t print anything on the screen. &amp;step_quit, FLOW_LOOP ); The definition of step_upper_delimiter, step_lower_delimiter and step_generic could look like this: // Note we&#39;re using UX_STEP_INIT because this step won&#39;t display anything. UX_STEP_INIT( step_upper_delimiter, NULL, NULL, { // This function will be detailed later on. display_next_state(true); } ); UX_STEP_NOCB( step_generic, bnnn_paging, { .title = global.title, .text = global.text, } ); // Note we&#39;re using UX_STEP_INIT because this step won&#39;t display anything. UX_STEP_INIT( step_lower_delimiter, NULL, NULL, { // This function will be detailed later on. display_next_state(false); } ); As you can see, step_upper_delimiter and step_lower_delimiter are very similar. step_generic is a simple bnnn_paging that will always display what’s located in global.title and global.text. And now we only need to implement the special logic for this to work! Inside the .h file, we only need to add an enum definition and an instance of this enum in our global structure: // State of the dynamic display. // Use to keep track of whether we are displaying screens that are inside the // array (dynamic), or outside the array (static). enum e_state { STATIC_SCREEN, DYNAMIC_SCREEN, }; struct global { // An instance of our new enum enum e_state current_state; // The rest of the global stays unchanged... } And in the .c file, we add all the business logic. A helper function is used throughout the code. This function is yours to define, and basically fills the title_buffer and the text_buffer with the appropriate strings. Is returns a bool corresponding to whether or not it found data to fill the buffers. The :code:`bool forward parameter is used to indicate whether we wish to display the next screen or the previous screen. The code is commented thoroughly, so take your time and read it carefully. // This is a special function we must call for bnnn_paging to work properly in an edgecase. // It does some weird stuff with the `G_ux` global which is defined by the SDK. // No need to dig deeper into the code, a simple copy paste will do. void bnnn_paging_edgecase() { G_ux.flow_stack[G_ux.stack_count - 1].prev_index = G_ux.flow_stack[G_ux.stack_count - 1].index - 2; G_ux.flow_stack[G_ux.stack_count - 1].index--; ux_flow_relayout(); } // Main function that handles all the business logic for our new display architecture. void display_next_state(bool is_upper_delimiter) { if (is_upper_delimiter) { // We&#39;re called from the upper delimiter. if (global.current_state == STATIC_SCREEN) { // Fetch new data. bool dynamic_data = get_next_data(&amp;global.title, &amp;global.text, true); if (dynamic_data) { // We found some data to display so we now enter in dynamic mode. global.current_state = DYNAMIC_SCREEN; } // Move to the next step, which will display the screen. ux_flow_next(); } else { // The previous screen was NOT a static screen, so we were already in a dynamic screen. // Fetch new data. bool dynamic_data = get_next_data(&amp;global.title, &amp;globa.text, false); if (dynamic_data) { // We found some data so simply display it. ux_flow_next(); } else { // There&#39;s no more dynamic data to display, so // update the current state accordingly. global.current_state = STATIC_SCREEN; // Display the previous screen which should be a static one. ux_flow_prev(); } } else { // We&#39;re called from the lower delimiter. if (global.current_state == STATIC_SCREEN) { // Fetch new data. bool dynamic_data = get_next_data(&amp;global.title, &amp;global.text, false); if (dynamic_data) { // We found some data to display so enter in dynamic mode. global.current_state = DYNAMIC_SCREEN; } // Display the data. ux_flow_prev(); } else { // We&#39;re being called from a dynamic screen, so the user was already browsing the array. // Fetch new data. bool dynamic_data = get_next_data(&amp;global.title, &amp;global.text, true); if (dynamic_data) { // We found some data, so display it. // Similar to `ux_flow_prev()` but updates layout to account for `bnnn_paging`&#39;s weird behaviour. bnnn_paging_edgecase(); } else { // We found no data so make sure we update the state accordingly. global.current_state = STATIC_SCREEN; // Display the next screen ux_flow_next(); } } } } } That was a mouthful! But we did it: we managed to dynamically adapt our flow AND our steps!" />
<meta property="og:description" content="Sections in this article Introduction Cherry-picking steps at runtime Usecase Cherry-picking explained Defining steps at runtime Introduction This article talks about more advanced flows that are sometimes needed when writing applications. Cherry-picking steps at runtime Usecase The Display Management &lt;/u_display_management&gt; doc taught us how to use the UX_FLOW macro. This macro is quite handy but comes with its drawbacks: everything needs to be declared at compilation time. What if we wished to change the flow at runtime? Imagine an app where you have a flow for a transaction signature. UX_FLOW(ux_transaction_signature, &amp;step_review, &amp;step_amount, &amp;step_fee, &amp;step_address, &amp;step_accept, &amp;step_reject ); This works well enough for a transaction signature. But suppose there’s an update to the protocol: now some transactions can also sign some arbitrary data. However, not all transactions are required to sign the arbitrary data, so you need two flows: // The standard signature, nothing has changed. UX_FLOW(ux_vanilla_transaction_signature, &amp;step_review, &amp;step_amount, &amp;step_fee, &amp;step_address, &amp;step_accept, &amp;step_reject ); // This flow is almost the same as the one above, except is contains &quot;step_arbitrary_data&quot;. UX_FLOW(ux_data_transaction_signature, &amp;step_review, &amp;step_amount, &amp;step_fee, &amp;step_address, &amp;step_arbitrary_data, // Arbitrary data &amp;step_accept, &amp;step_reject ); And now somewhere in your app at runtime you will be able to decide which flow to use: void launch_flow() { if (g.has_arbitrary_data) { ux_flow_init(0, ux_data_transaction_signature, NULL); } else { ux_flow_init(0, ux_vanilla_transaction_signature, NULL); } } Great this works. Hu-oh but now the community also wants to be able to see the nonce for the transaction. But they want it to be optional. You know for advanced users. Ok so back to work: we need a flow for the vanilla signature, as well as a flow for the vanilla signature where we show the nonce. Oh but wait we also need the option to display the nonce when there is arbitrary data to sign, so we also need the “data signature” flow and the “data signature + nonce” flow. // The standard signature, nothing has changed. UX_FLOW(ux_vanilla_transaction_signature, &amp;step_review, &amp;step_amount, &amp;step_fee, &amp;step_address, &amp;step_accept, &amp;step_reject ); // Now the vanilla flow where we just add the step to display the nonce. UX_FLOW(ux_vanilla_nonce_transaction_signature, &amp;step_review, &amp;step_amount, &amp;step_fee, &amp;step_address, &amp;step_nonce, // Nonce &amp;step_accept, &amp;step_reject ); // This is identical to the previous example, where we signed some arbitrary data. UX_FLOW(ux_data_transaction_signature, &amp;step_review, &amp;step_amount, &amp;step_fee, &amp;step_address, &amp;step_arbitrary_data, // Arbitrary data &amp;step_accept, &amp;step_reject ); // This is identical to the flow just above, except we add a step to display the nonce. UX_FLOW(ux_data_nonce_transaction_signature, &amp;step_review, &amp;step_amount, &amp;step_fee, &amp;step_address, &amp;step_arbitrary_data, // Arbitrary data &amp;step_nonce, // Nonce &amp;step_accept, &amp;step_reject ); And now somewhere in our app at runtime we’re able to decide which flow to use: void launch_flow() { if (g.has_arbitrary_data) { if (g.display_nonce) { ux_flow_init(0, ux_data_nonce_transaction_signature, NULL); } else { ux_flow_init(0, ux_data_transaction_signature, NULL); } } else { if (g.display_nonce) { ux_flow_init(0, ux_vanilla_nonce_transaction_signature, NULL); } else { ux_flow_init(0, ux_vanilla_transaction_signature, NULL); } } } Ugh. Ok now everyone’s happy: we’ve updated our app to support the protocol and the advanced users in the community can display the nonce. But now a new upgrade to the protocol is planned for the near future: the fees can sometimes be paid by another user of the blockchain, called a relayer. Anyways now some transactions now need to hide the fees (displaying a fee of 0.000 is not an option because it would confuse users more than anything). So we need… 8 different flows. That escalated quickly! Indeed, for every little upgrade, we’re doubling the number of flows. Soon enough we’ll end up with 16 or even 32 different flows… Notice that whilst the number of flows will grow exponentially, the number of different steps though will only grow linearly (one for every new feature). To fix this problem, we would need to define the UX_FLOW at runtime, cherry-picking which steps we wish to include depending on the details of our transaction. Don’t worry, Ledger’s got your back! The fix is quite simple, so let’s dive right into it! Cherry-picking explained The idea is to create an array of steps that would be big enough to fit all the steps. Since steps grow linearly, this array won’t be too big. Once this array created, we simply need to fill it with the steps we wish to include. Finally, we need to add a last step FLOW_END_STEP for it to work properly. We can then call the ux_init_flow and pass in our array as argument! // The maximum number of steps we will ever need. Here it&#39;s 8: step_review, step_amount, // step_fee, step_address, step_arbitrary_data, step_nonce, step_accept, step_reject. #define MAX_NUM_STEPS 8 // The array of steps. Notice the type used, as it&#39;s important if you wish to use ux_init_flow. // We&#39;re adding `+ 1` because we need to ensure we always have extra room for the last step, FLOW_END_STEP. const ux_flow_step_t *ux_signature_flow[MAX_NUM_STEPS + 1]; void start_display() { uint8_t index = 0; // Set the first step to be `step_review`, and then increment `index`. ux_signature_flow[index++] = step_review; // Set the second step to be `step_amount`, and then increment `index`. ux_signature_flow[index++] = step_amount; // etc... ux_signature_flow[index++] = step_fee; ux_signature_flow[index++] = step_address; // We can now conditionally add steps at runtime! if (g.has_arbitrary_data) { ux_signature_flow[index++] = step_arbitrary_data; } if (g.display_nonce) { ux_signature_flow[index++] = step_nonce; } ux_signature_flow[index++] = step_accept; ux_signature_flow[index++] = step_reject; // Don&#39;t forget to finish your flow with this special step. ux_signature_flow[index++] = FLOW_END_STEP; // Start the display! ux_init_flow(0, ux_signature_flow, NULL); } Defining steps at runtime In the previous section we saw that we could define a UX_FLOW at runtime. But we did this whilst still having steps defined statically. What if we wish to define steps at runtime too? This would give us a very fine-grained control over what we wish to display, without having to declare a step everytime. Finding a step that would be generic enough to fit all our needs. Naively, the code we’d expect would look something like that: // Naive definition of a UX_FLOW. // Note: we are still keeping step_review, step_accept and // step_reject because we know our flow will need those anyway. UX_FLOW(ideal_dynamic_fow, &amp;step_welcome, &amp;step_generic, // A generic step that would fit all our needs. &amp;step_quit FLOW_LOOP ); However this wouldn’t work: if we only defined a single step, then how could it dynamically change its information? Pressing the right button would make it loop and we’d end up on the same exact screen, and pressing the left button would lead to the same situation. So here’s a solution: Add an extra step just before the step_generic step, and another one right after it. Those extra steps are nothing but delimiters for the step_generic . They allow us to execute special logic to update the screen and redisplay it. They also allow us to keep track of an index, so that we know whether we’re still within our array boundaries or not. Here’s what the code looks like. UX_FLOW(dynamic_flow, &amp;step_welcome, &amp;step_upper_delimiter, // A special step that serves as the upper delimiter. It won&#39;t print anything on the screen. &amp;step_generic, // Our generic step that will actually display stuff on the screen. &amp;step_lower_delimiter, // A special step that serves as the lower delimiter. It won&#39;t print anything on the screen. &amp;step_quit, FLOW_LOOP ); The definition of step_upper_delimiter, step_lower_delimiter and step_generic could look like this: // Note we&#39;re using UX_STEP_INIT because this step won&#39;t display anything. UX_STEP_INIT( step_upper_delimiter, NULL, NULL, { // This function will be detailed later on. display_next_state(true); } ); UX_STEP_NOCB( step_generic, bnnn_paging, { .title = global.title, .text = global.text, } ); // Note we&#39;re using UX_STEP_INIT because this step won&#39;t display anything. UX_STEP_INIT( step_lower_delimiter, NULL, NULL, { // This function will be detailed later on. display_next_state(false); } ); As you can see, step_upper_delimiter and step_lower_delimiter are very similar. step_generic is a simple bnnn_paging that will always display what’s located in global.title and global.text. And now we only need to implement the special logic for this to work! Inside the .h file, we only need to add an enum definition and an instance of this enum in our global structure: // State of the dynamic display. // Use to keep track of whether we are displaying screens that are inside the // array (dynamic), or outside the array (static). enum e_state { STATIC_SCREEN, DYNAMIC_SCREEN, }; struct global { // An instance of our new enum enum e_state current_state; // The rest of the global stays unchanged... } And in the .c file, we add all the business logic. A helper function is used throughout the code. This function is yours to define, and basically fills the title_buffer and the text_buffer with the appropriate strings. Is returns a bool corresponding to whether or not it found data to fill the buffers. The :code:`bool forward parameter is used to indicate whether we wish to display the next screen or the previous screen. The code is commented thoroughly, so take your time and read it carefully. // This is a special function we must call for bnnn_paging to work properly in an edgecase. // It does some weird stuff with the `G_ux` global which is defined by the SDK. // No need to dig deeper into the code, a simple copy paste will do. void bnnn_paging_edgecase() { G_ux.flow_stack[G_ux.stack_count - 1].prev_index = G_ux.flow_stack[G_ux.stack_count - 1].index - 2; G_ux.flow_stack[G_ux.stack_count - 1].index--; ux_flow_relayout(); } // Main function that handles all the business logic for our new display architecture. void display_next_state(bool is_upper_delimiter) { if (is_upper_delimiter) { // We&#39;re called from the upper delimiter. if (global.current_state == STATIC_SCREEN) { // Fetch new data. bool dynamic_data = get_next_data(&amp;global.title, &amp;global.text, true); if (dynamic_data) { // We found some data to display so we now enter in dynamic mode. global.current_state = DYNAMIC_SCREEN; } // Move to the next step, which will display the screen. ux_flow_next(); } else { // The previous screen was NOT a static screen, so we were already in a dynamic screen. // Fetch new data. bool dynamic_data = get_next_data(&amp;global.title, &amp;globa.text, false); if (dynamic_data) { // We found some data so simply display it. ux_flow_next(); } else { // There&#39;s no more dynamic data to display, so // update the current state accordingly. global.current_state = STATIC_SCREEN; // Display the previous screen which should be a static one. ux_flow_prev(); } } else { // We&#39;re called from the lower delimiter. if (global.current_state == STATIC_SCREEN) { // Fetch new data. bool dynamic_data = get_next_data(&amp;global.title, &amp;global.text, false); if (dynamic_data) { // We found some data to display so enter in dynamic mode. global.current_state = DYNAMIC_SCREEN; } // Display the data. ux_flow_prev(); } else { // We&#39;re being called from a dynamic screen, so the user was already browsing the array. // Fetch new data. bool dynamic_data = get_next_data(&amp;global.title, &amp;global.text, true); if (dynamic_data) { // We found some data, so display it. // Similar to `ux_flow_prev()` but updates layout to account for `bnnn_paging`&#39;s weird behaviour. bnnn_paging_edgecase(); } else { // We found no data so make sure we update the state accordingly. global.current_state = STATIC_SCREEN; // Display the next screen ux_flow_next(); } } } } } That was a mouthful! But we did it: we managed to dynamically adapt our flow AND our steps!" />
<link rel="canonical" href="http://localhost:4000/docs/NA/u_advanced_display_management/" />
<meta property="og:url" content="http://localhost:4000/docs/NA/u_advanced_display_management/" />
<meta property="og:site_name" content="Ledger Developer pages" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-04-22T15:38:24+02:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Advanced display management" />
<script type="application/ld+json">
{"datePublished":"2021-04-22T15:38:24+02:00","description":"Sections in this article Introduction Cherry-picking steps at runtime Usecase Cherry-picking explained Defining steps at runtime Introduction This article talks about more advanced flows that are sometimes needed when writing applications. Cherry-picking steps at runtime Usecase The Display Management &lt;/u_display_management&gt; doc taught us how to use the UX_FLOW macro. This macro is quite handy but comes with its drawbacks: everything needs to be declared at compilation time. What if we wished to change the flow at runtime? Imagine an app where you have a flow for a transaction signature. UX_FLOW(ux_transaction_signature, &amp;step_review, &amp;step_amount, &amp;step_fee, &amp;step_address, &amp;step_accept, &amp;step_reject ); This works well enough for a transaction signature. But suppose there’s an update to the protocol: now some transactions can also sign some arbitrary data. However, not all transactions are required to sign the arbitrary data, so you need two flows: // The standard signature, nothing has changed. UX_FLOW(ux_vanilla_transaction_signature, &amp;step_review, &amp;step_amount, &amp;step_fee, &amp;step_address, &amp;step_accept, &amp;step_reject ); // This flow is almost the same as the one above, except is contains &quot;step_arbitrary_data&quot;. UX_FLOW(ux_data_transaction_signature, &amp;step_review, &amp;step_amount, &amp;step_fee, &amp;step_address, &amp;step_arbitrary_data, // Arbitrary data &amp;step_accept, &amp;step_reject ); And now somewhere in your app at runtime you will be able to decide which flow to use: void launch_flow() { if (g.has_arbitrary_data) { ux_flow_init(0, ux_data_transaction_signature, NULL); } else { ux_flow_init(0, ux_vanilla_transaction_signature, NULL); } } Great this works. Hu-oh but now the community also wants to be able to see the nonce for the transaction. But they want it to be optional. You know for advanced users. Ok so back to work: we need a flow for the vanilla signature, as well as a flow for the vanilla signature where we show the nonce. Oh but wait we also need the option to display the nonce when there is arbitrary data to sign, so we also need the “data signature” flow and the “data signature + nonce” flow. // The standard signature, nothing has changed. UX_FLOW(ux_vanilla_transaction_signature, &amp;step_review, &amp;step_amount, &amp;step_fee, &amp;step_address, &amp;step_accept, &amp;step_reject ); // Now the vanilla flow where we just add the step to display the nonce. UX_FLOW(ux_vanilla_nonce_transaction_signature, &amp;step_review, &amp;step_amount, &amp;step_fee, &amp;step_address, &amp;step_nonce, // Nonce &amp;step_accept, &amp;step_reject ); // This is identical to the previous example, where we signed some arbitrary data. UX_FLOW(ux_data_transaction_signature, &amp;step_review, &amp;step_amount, &amp;step_fee, &amp;step_address, &amp;step_arbitrary_data, // Arbitrary data &amp;step_accept, &amp;step_reject ); // This is identical to the flow just above, except we add a step to display the nonce. UX_FLOW(ux_data_nonce_transaction_signature, &amp;step_review, &amp;step_amount, &amp;step_fee, &amp;step_address, &amp;step_arbitrary_data, // Arbitrary data &amp;step_nonce, // Nonce &amp;step_accept, &amp;step_reject ); And now somewhere in our app at runtime we’re able to decide which flow to use: void launch_flow() { if (g.has_arbitrary_data) { if (g.display_nonce) { ux_flow_init(0, ux_data_nonce_transaction_signature, NULL); } else { ux_flow_init(0, ux_data_transaction_signature, NULL); } } else { if (g.display_nonce) { ux_flow_init(0, ux_vanilla_nonce_transaction_signature, NULL); } else { ux_flow_init(0, ux_vanilla_transaction_signature, NULL); } } } Ugh. Ok now everyone’s happy: we’ve updated our app to support the protocol and the advanced users in the community can display the nonce. But now a new upgrade to the protocol is planned for the near future: the fees can sometimes be paid by another user of the blockchain, called a relayer. Anyways now some transactions now need to hide the fees (displaying a fee of 0.000 is not an option because it would confuse users more than anything). So we need… 8 different flows. That escalated quickly! Indeed, for every little upgrade, we’re doubling the number of flows. Soon enough we’ll end up with 16 or even 32 different flows… Notice that whilst the number of flows will grow exponentially, the number of different steps though will only grow linearly (one for every new feature). To fix this problem, we would need to define the UX_FLOW at runtime, cherry-picking which steps we wish to include depending on the details of our transaction. Don’t worry, Ledger’s got your back! The fix is quite simple, so let’s dive right into it! Cherry-picking explained The idea is to create an array of steps that would be big enough to fit all the steps. Since steps grow linearly, this array won’t be too big. Once this array created, we simply need to fill it with the steps we wish to include. Finally, we need to add a last step FLOW_END_STEP for it to work properly. We can then call the ux_init_flow and pass in our array as argument! // The maximum number of steps we will ever need. Here it&#39;s 8: step_review, step_amount, // step_fee, step_address, step_arbitrary_data, step_nonce, step_accept, step_reject. #define MAX_NUM_STEPS 8 // The array of steps. Notice the type used, as it&#39;s important if you wish to use ux_init_flow. // We&#39;re adding `+ 1` because we need to ensure we always have extra room for the last step, FLOW_END_STEP. const ux_flow_step_t *ux_signature_flow[MAX_NUM_STEPS + 1]; void start_display() { uint8_t index = 0; // Set the first step to be `step_review`, and then increment `index`. ux_signature_flow[index++] = step_review; // Set the second step to be `step_amount`, and then increment `index`. ux_signature_flow[index++] = step_amount; // etc... ux_signature_flow[index++] = step_fee; ux_signature_flow[index++] = step_address; // We can now conditionally add steps at runtime! if (g.has_arbitrary_data) { ux_signature_flow[index++] = step_arbitrary_data; } if (g.display_nonce) { ux_signature_flow[index++] = step_nonce; } ux_signature_flow[index++] = step_accept; ux_signature_flow[index++] = step_reject; // Don&#39;t forget to finish your flow with this special step. ux_signature_flow[index++] = FLOW_END_STEP; // Start the display! ux_init_flow(0, ux_signature_flow, NULL); } Defining steps at runtime In the previous section we saw that we could define a UX_FLOW at runtime. But we did this whilst still having steps defined statically. What if we wish to define steps at runtime too? This would give us a very fine-grained control over what we wish to display, without having to declare a step everytime. Finding a step that would be generic enough to fit all our needs. Naively, the code we’d expect would look something like that: // Naive definition of a UX_FLOW. // Note: we are still keeping step_review, step_accept and // step_reject because we know our flow will need those anyway. UX_FLOW(ideal_dynamic_fow, &amp;step_welcome, &amp;step_generic, // A generic step that would fit all our needs. &amp;step_quit FLOW_LOOP ); However this wouldn’t work: if we only defined a single step, then how could it dynamically change its information? Pressing the right button would make it loop and we’d end up on the same exact screen, and pressing the left button would lead to the same situation. So here’s a solution: Add an extra step just before the step_generic step, and another one right after it. Those extra steps are nothing but delimiters for the step_generic . They allow us to execute special logic to update the screen and redisplay it. They also allow us to keep track of an index, so that we know whether we’re still within our array boundaries or not. Here’s what the code looks like. UX_FLOW(dynamic_flow, &amp;step_welcome, &amp;step_upper_delimiter, // A special step that serves as the upper delimiter. It won&#39;t print anything on the screen. &amp;step_generic, // Our generic step that will actually display stuff on the screen. &amp;step_lower_delimiter, // A special step that serves as the lower delimiter. It won&#39;t print anything on the screen. &amp;step_quit, FLOW_LOOP ); The definition of step_upper_delimiter, step_lower_delimiter and step_generic could look like this: // Note we&#39;re using UX_STEP_INIT because this step won&#39;t display anything. UX_STEP_INIT( step_upper_delimiter, NULL, NULL, { // This function will be detailed later on. display_next_state(true); } ); UX_STEP_NOCB( step_generic, bnnn_paging, { .title = global.title, .text = global.text, } ); // Note we&#39;re using UX_STEP_INIT because this step won&#39;t display anything. UX_STEP_INIT( step_lower_delimiter, NULL, NULL, { // This function will be detailed later on. display_next_state(false); } ); As you can see, step_upper_delimiter and step_lower_delimiter are very similar. step_generic is a simple bnnn_paging that will always display what’s located in global.title and global.text. And now we only need to implement the special logic for this to work! Inside the .h file, we only need to add an enum definition and an instance of this enum in our global structure: // State of the dynamic display. // Use to keep track of whether we are displaying screens that are inside the // array (dynamic), or outside the array (static). enum e_state { STATIC_SCREEN, DYNAMIC_SCREEN, }; struct global { // An instance of our new enum enum e_state current_state; // The rest of the global stays unchanged... } And in the .c file, we add all the business logic. A helper function is used throughout the code. This function is yours to define, and basically fills the title_buffer and the text_buffer with the appropriate strings. Is returns a bool corresponding to whether or not it found data to fill the buffers. The :code:`bool forward parameter is used to indicate whether we wish to display the next screen or the previous screen. The code is commented thoroughly, so take your time and read it carefully. // This is a special function we must call for bnnn_paging to work properly in an edgecase. // It does some weird stuff with the `G_ux` global which is defined by the SDK. // No need to dig deeper into the code, a simple copy paste will do. void bnnn_paging_edgecase() { G_ux.flow_stack[G_ux.stack_count - 1].prev_index = G_ux.flow_stack[G_ux.stack_count - 1].index - 2; G_ux.flow_stack[G_ux.stack_count - 1].index--; ux_flow_relayout(); } // Main function that handles all the business logic for our new display architecture. void display_next_state(bool is_upper_delimiter) { if (is_upper_delimiter) { // We&#39;re called from the upper delimiter. if (global.current_state == STATIC_SCREEN) { // Fetch new data. bool dynamic_data = get_next_data(&amp;global.title, &amp;global.text, true); if (dynamic_data) { // We found some data to display so we now enter in dynamic mode. global.current_state = DYNAMIC_SCREEN; } // Move to the next step, which will display the screen. ux_flow_next(); } else { // The previous screen was NOT a static screen, so we were already in a dynamic screen. // Fetch new data. bool dynamic_data = get_next_data(&amp;global.title, &amp;globa.text, false); if (dynamic_data) { // We found some data so simply display it. ux_flow_next(); } else { // There&#39;s no more dynamic data to display, so // update the current state accordingly. global.current_state = STATIC_SCREEN; // Display the previous screen which should be a static one. ux_flow_prev(); } } else { // We&#39;re called from the lower delimiter. if (global.current_state == STATIC_SCREEN) { // Fetch new data. bool dynamic_data = get_next_data(&amp;global.title, &amp;global.text, false); if (dynamic_data) { // We found some data to display so enter in dynamic mode. global.current_state = DYNAMIC_SCREEN; } // Display the data. ux_flow_prev(); } else { // We&#39;re being called from a dynamic screen, so the user was already browsing the array. // Fetch new data. bool dynamic_data = get_next_data(&amp;global.title, &amp;global.text, true); if (dynamic_data) { // We found some data, so display it. // Similar to `ux_flow_prev()` but updates layout to account for `bnnn_paging`&#39;s weird behaviour. bnnn_paging_edgecase(); } else { // We found no data so make sure we update the state accordingly. global.current_state = STATIC_SCREEN; // Display the next screen ux_flow_next(); } } } } } That was a mouthful! But we did it: we managed to dynamically adapt our flow AND our steps!","dateModified":"2021-04-22T15:38:24+02:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/docs/NA/u_advanced_display_management/"},"url":"http://localhost:4000/docs/NA/u_advanced_display_management/","author":{"@type":"Person","name":"pscott"},"@type":"BlogPosting","headline":"Advanced display management","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

  <meta property="og:image" content="http://localhost:4000/uploads/"/>
  <link rel="stylesheet" href="/assets/css/main.css">
  <link rel="shortcut icon" type="image/png" href="/uploads/favicon.png" >
  <link rel="alternate" type="application/rss+xml" title="Ledger Developer pages" href="/feed.xml">
  <script src="/assets/js/main.js"></script>
  
    <script>
function searchResults(form) {

    var currentItem = null;
    var search = document.getElementById(form);
    var results = document.getElementById(form + "-results");
    var toggle = document.getElementById(form + "-toggle");

    function removeActive() {
        for (i = 0; i < results.children.length; i++) {
            results.children[i].classList.remove("uk-background-muted");
        }
    }

    // Detect all clicks on the document
    document.addEventListener("click", function(event) {

        var isClickSearch = false;
        var isClickResults = false;
        var isClickSearchToggle = false;

        if (search !== null) {
            isClickSearch = search.contains(event.target);
        }

        if (results !== null) {
            isClickResults = results.contains(event.target);
        }

        if (toggle !== null) {
            isClickSearchToggle = toggle.contains(event.target);
        }

        if (isClickSearch || isClickSearchToggle) {
            results.style.display = "block";
        }        

        if (!isClickResults && !isClickSearch && !isClickSearchToggle) {
            results.style.display = "none";
        }        
        
    });    

    results.addEventListener("mouseover", function(event) {

        removeActive();
        event.target.parentElement.classList.add("uk-background-muted");
        currentItem = null;

    });

    results.addEventListener("mouseout", function(event) {
        event.target.parentElement.classList.remove("uk-background-muted");
    });


    search.addEventListener("keyup", function(event) {

        var resultItems = results.children;
        var resultCount = results.children.length;
                                
        if (event.keyCode === 40) {

            if (currentItem < (resultCount - 1)) {
                if (currentItem === null) {
                    currentItem = 0;
                } else {
                    removeActive();
                    currentItem++;
                }
                removeActive();
                resultItems[currentItem].classList.add("uk-background-muted");
            }
            
        } else if (event.keyCode === 38) {

            if (currentItem > 0) {
                if (currentItem === null) {
                    currentItem = 0;
                } else {
                    removeActive();
                    currentItem--;
                }
                removeActive();
                resultItems[currentItem].classList.add("uk-background-muted");
            }

        } else if (event.keyCode === 13) {

            resultItems[currentItem].children[0].click();

        }

    });

}
</script>
  
  
  
<script src="http://127.0.0.1:35729/livereload.js"></script></head>

    <body>

    
        <div data-uk-sticky="animation: uk-animation-slide-top; sel-target: .uk-navbar-container; cls-active: uk-navbar-sticky; cls-inactive: uk-navbar-transparent; top: 200">
    <nav class="uk-navbar-container">
        <div class="uk-container">
            <div data-uk-navbar>
                <div class="uk-navbar-left">
                    <a class="uk-navbar-item uk-logo uk-visible@m" href="/">Ledger Developer pages</a>
                    
                        <a class="uk-navbar-toggle uk-hidden@m" href="#offcanvas-docs" data-uk-toggle><span data-uk-navbar-toggle-icon></span> <span class="uk-margin-small-left">Docs</span></a>
                    

                    <ul class="uk-navbar-nav uk-visible@m">
                        
                            
                            
                            
                                
                                    
                                        <li><a href="/docs/00_header/" >Creating content</a></li>
                                                                                                        
                                
                            
                        
                            
                            
                            
                                
                                    
                                        <li><a href="/docs/00_header/" >Tools & Frameworks</a></li>
                                                                                                        
                                
                            
                        
                            
                            
                            
                                
                                    
                                        <li><a href="/docs/00_header/" >Release notes</a></li>
                                                                                                        
                                
                            
                        
                            
                            
                            
                                
                                    
                                        <li><a href="/docs/00_header/" >Tutorials</a></li>
                                                                                                        
                                
                            
                        
                            
                            
                            
                                
                                    
                                        <li><a href="#">_Old</a>
                                        
                                            <div class="uk-navbar-dropdown">
                                                <ul class="uk-nav uk-navbar-dropdown-nav">
                                                    
                                                    
                                                        
                                                        
                                                        <li><a href="/docs/TMPL/installation/">Template docs</a></li>
                                                    
                                                    
                                                    
                                                        
                                                        
                                                        <li><a href="/blog/">Blog</a></li>
                                                    
                                                    
                                                    
                                                        <li class="uk-nav-header">Changelogs</li>
                                                    
                                                    
                                                </ul>
                                            </div>
                                        
                                        </li>
                                                                                                        
                                
                            
                        
                    </ul>
                </div>
                <div class="uk-navbar-center uk-hidden@m">
                    <a class="uk-navbar-item uk-logo" href="/">Ledger Developer pages</a>
                </div>
                <div class="uk-navbar-right">
                    
                        
                            <div>
                                <a id="search-navbar-toggle" class="uk-navbar-toggle" uk-search-icon href="#"></a>
                                <div class="uk-drop uk-background-default uk-border-rounded" uk-drop="mode: click; pos: left-center; offset: 0">
                                    <form class="uk-search uk-search-navbar uk-width-1-1" onsubmit="return false;">
                                        <input id="search-navbar" class="uk-search-input" type="search" placeholder="Search for answers" autofocus autocomplete="off">
                                    </form>
                                    <ul id="search-navbar-results" class="uk-position-absolute uk-width-1-1 uk-list"></ul>
                                </div>
                            </div>
                            <script>
                            SimpleJekyllSearch({
                                searchInput: document.getElementById('search-navbar'),
                                resultsContainer: document.getElementById('search-navbar-results'),
                                noResultsText: '<li class="no-results">No results found</li>',
                                searchResultTemplate: '<li><a href="{url}">{title}</a></li>',
                                json: "/search.json"
                            });
                            searchResults("search-navbar");
                            </script>
                        
                    

                    <ul class="uk-navbar-nav uk-visible@m">
                        
                    </ul>

                    
                        <a class="uk-navbar-toggle uk-hidden@m" href="#offcanvas" data-uk-toggle><span data-uk-navbar-toggle-icon></span> <span class="uk-margin-small-left">Menu</span></a>
                    

                </div>
            </div>
        </div>
    </nav>
</div>
    

    <div class="uk-section">
    <div class="uk-container">
        <div class="uk-grid-large" data-uk-grid>

            <div class="sidebar-fixed-width uk-visible@m">
                <div class="sidebar-docs uk-position-fixed uk-margin-top">
                    
                    <h5>Background Information</h5>
                    <ul class="uk-nav uk-nav-default doc-nav">
                    
                      
                      
                      <li class=""><a href="/docs/NA/bg_introduction/">Introduction</a></li>
                    
                      
                      
                      <li class=""><a href="/docs/NA/bg_personal_security_devices/">Personal Security Devices</a></li>
                    
                      
                      
                      <li class=""><a href="/docs/NA/bg_master_seed/">The Master Seed</a></li>
                    
                      
                      
                      <li class=""><a href="/docs/NA/bg_hd_keys/">HD Key Generation</a></li>
                    
                      
                      
                      <li class=""><a href="/docs/NA/bg_hd_use_cases/">Applications for HD Trees</a></li>
                    
                      
                      
                      <li class=""><a href="/docs/NA/bg_application_isolation/">Application Isolation</a></li>
                    
                    </ul>
                    
                    <h5>BOLOS Platform</h5>
                    <ul class="uk-nav uk-nav-default doc-nav">
                    
                      
                      
                      <li class=""><a href="/docs/NA/b_introduction/">Introduction</a></li>
                    
                      
                      
                      <li class=""><a href="/docs/NA/b_overview/">Overview</a></li>
                    
                      
                      
                      <li class=""><a href="/docs/NA/b_features/">BOLOS Features</a></li>
                    
                      
                      
                      <li class=""><a href="/docs/NA/b_hardware_architecture/">Hardware Architecture</a></li>
                    
                      
                      
                      <li class=""><a href="/docs/NA/b_application_environment/">Application Environment</a></li>
                    
                    </ul>
                    
                    <h5>Userspace Development</h5>
                    <ul class="uk-nav uk-nav-default doc-nav">
                    
                      
                      
                      <li class=""><a href="/docs/NA/u_introduction/">Introduction</a></li>
                    
                      
                      
                      <li class=""><a href="/docs/NA/u_setup/">Setting it up</a></li>
                    
                      
                      
                      <li class=""><a href="/docs/NA/u_writing_apps/">Writing Apps</a></li>
                    
                      
                      
                      <li class=""><a href="/docs/NA/u_display_management/">Display Management</a></li>
                    
                      
                      
                      <li class="uk-active"><a href="/docs/NA/u_advanced_display_management/">Advanced display management</a></li>
                    
                      
                      
                      <li class=""><a href="/docs/NA/u_low_level_display_management/">Low-level display management</a></li>
                    
                      
                      
                      <li class=""><a href="/docs/NA/u_syscalls/">Interaction Between BOLOS and Apps</a></li>
                    
                      
                      
                      <li class=""><a href="/docs/NA/u_application_structure/">Application Structure and I/O</a></li>
                    
                      
                      
                      <li class=""><a href="/docs/NA/u_memory/">Persistent Storage and PIC</a></li>
                    
                      
                      
                      <li class=""><a href="/docs/NA/u_alignment/">Memory alignment</a></li>
                    
                      
                      
                      <li class=""><a href="/docs/NA/u_troubleshooting/">Common Pitfalls and Troubleshooting</a></li>
                    
                      
                      
                      <li class=""><a href="/docs/NA/u_debugging/">Application Debug</a></li>
                    
                      
                      
                      <li class=""><a href="/docs/NA/u_speculos/">Emulating devices with Speculos</a></li>
                    
                    </ul>
                    
                    <h5>Additional Resources</h5>
                    <ul class="uk-nav uk-nav-default doc-nav">
                    
                      
                      
                      <li class=""><a href="/docs/NA/a_publishing_an_app/">Publishing an Application</a></li>
                    
                      
                      
                      <li class=""><a href="/docs/NA/a_external_docs/">External Documentation</a></li>
                    
                      
                      
                      <li class=""><a href="/docs/NA/a_security_guidelines/">Developing Secure Ledger Apps</a></li>
                    
                    </ul>
                    
                </div>
            </div>

            <div class="uk-width-1-1 uk-width-expand@m">

                <article class="uk-article">

                    <h1 class="uk-article-title">Advanced display management</h1>

                    <p class="uk-text-lead uk-text-muted">Advanced flows for advanced uses</p>

                    <div class="uk-article-meta uk-margin-top uk-margin-medium-bottom uk-flex uk-flex-middle">
                        


  
  <img class="uk-border-circle avatar" src="http://localhost:4000/uploads/avatar-pscott.jpg" alt="pscott">


<div>
  
    Written by <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span itemprop="name">pscott</span></span><br>
  
  <time datetime="" itemprop="datePublished">
    
    
  </time>
</div>
                    </div>

                    <div class="article-content link-primary">
                        <h4 class="no_toc" id="sections-in-this-article">Sections in this article</h4>
<ul id="markdown-toc">
  <li><a href="#introduction" id="markdown-toc-introduction">Introduction</a>    <ul>
      <li><a href="#cherry-picking-steps-at-runtime" id="markdown-toc-cherry-picking-steps-at-runtime">Cherry-picking steps at runtime</a>        <ul>
          <li><a href="#usecase" id="markdown-toc-usecase">Usecase</a></li>
          <li><a href="#cherry-picking-explained" id="markdown-toc-cherry-picking-explained">Cherry-picking explained</a></li>
        </ul>
      </li>
      <li><a href="#defining-steps-at-runtime" id="markdown-toc-defining-steps-at-runtime">Defining steps at runtime</a></li>
    </ul>
  </li>
</ul>

<h2 id="introduction">Introduction</h2>

<p>This article talks about more advanced flows that are sometimes needed
when writing applications.</p>

<h3 id="cherry-picking-steps-at-runtime">Cherry-picking steps at runtime</h3>

<h4 id="usecase">Usecase</h4>

<p>The <code class="language-plaintext highlighter-rouge">Display Management &lt;/u_display_management&gt;</code> doc taught us
how to use the <code class="language-plaintext highlighter-rouge">UX_FLOW</code> macro. This macro is quite handy but comes with
its <strong>drawbacks</strong>: everything needs to be declared at <strong>compilation
time</strong>. What if we wished to change the <code class="language-plaintext highlighter-rouge">flow</code> at runtime?</p>

<p>Imagine an app where you have a flow for a transaction signature.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">UX_FLOW</span><span class="p">(</span><span class="n">ux_transaction_signature</span><span class="p">,</span>
         <span class="o">&amp;</span><span class="n">step_review</span><span class="p">,</span>
         <span class="o">&amp;</span><span class="n">step_amount</span><span class="p">,</span>
         <span class="o">&amp;</span><span class="n">step_fee</span><span class="p">,</span>
         <span class="o">&amp;</span><span class="n">step_address</span><span class="p">,</span>
         <span class="o">&amp;</span><span class="n">step_accept</span><span class="p">,</span>
         <span class="o">&amp;</span><span class="n">step_reject</span>
      <span class="p">);</span>
</code></pre></div></div>

<p>This works well enough for a transaction signature. But suppose there’s
an update to the protocol: now some transactions can also sign some
arbitrary data. However, not all transactions are required to sign the
arbitrary data, so you need two flows:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// The standard signature, nothing has changed.</span>
<span class="n">UX_FLOW</span><span class="p">(</span><span class="n">ux_vanilla_transaction_signature</span><span class="p">,</span>
         <span class="o">&amp;</span><span class="n">step_review</span><span class="p">,</span>
         <span class="o">&amp;</span><span class="n">step_amount</span><span class="p">,</span>
         <span class="o">&amp;</span><span class="n">step_fee</span><span class="p">,</span>
         <span class="o">&amp;</span><span class="n">step_address</span><span class="p">,</span>
         <span class="o">&amp;</span><span class="n">step_accept</span><span class="p">,</span>
         <span class="o">&amp;</span><span class="n">step_reject</span>
      <span class="p">);</span>

<span class="c1">// This flow is almost the same as the one above, except is contains "step_arbitrary_data".</span>
<span class="n">UX_FLOW</span><span class="p">(</span><span class="n">ux_data_transaction_signature</span><span class="p">,</span>
         <span class="o">&amp;</span><span class="n">step_review</span><span class="p">,</span>
         <span class="o">&amp;</span><span class="n">step_amount</span><span class="p">,</span>
         <span class="o">&amp;</span><span class="n">step_fee</span><span class="p">,</span>
         <span class="o">&amp;</span><span class="n">step_address</span><span class="p">,</span>
         <span class="o">&amp;</span><span class="n">step_arbitrary_data</span><span class="p">,</span> <span class="c1">// Arbitrary data</span>
         <span class="o">&amp;</span><span class="n">step_accept</span><span class="p">,</span>
         <span class="o">&amp;</span><span class="n">step_reject</span>
      <span class="p">);</span>
</code></pre></div></div>

<p>And now somewhere in your app at runtime you will be able to decide
which flow to use:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">launch_flow</span><span class="p">()</span> <span class="p">{</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">g</span><span class="p">.</span><span class="n">has_arbitrary_data</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">ux_flow_init</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ux_data_transaction_signature</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">ux_flow_init</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ux_vanilla_transaction_signature</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
   <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Great this works. Hu-oh but now the community also wants to be able to
see the nonce for the transaction. But they want it to be optional. You
know for <em>advanced</em> users.</p>

<p>Ok so back to work: we need a flow for the vanilla signature, as well as
a flow for the vanilla signature where we show the nonce. Oh but wait we
also need the option to display the nonce when there is arbitrary data
to sign, so we <strong>also</strong> need the “data signature” flow <strong>and</strong> the “data
signature + nonce” flow.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// The standard signature, nothing has changed.</span>
<span class="n">UX_FLOW</span><span class="p">(</span><span class="n">ux_vanilla_transaction_signature</span><span class="p">,</span>
         <span class="o">&amp;</span><span class="n">step_review</span><span class="p">,</span>
         <span class="o">&amp;</span><span class="n">step_amount</span><span class="p">,</span>
         <span class="o">&amp;</span><span class="n">step_fee</span><span class="p">,</span>
         <span class="o">&amp;</span><span class="n">step_address</span><span class="p">,</span>
         <span class="o">&amp;</span><span class="n">step_accept</span><span class="p">,</span>
         <span class="o">&amp;</span><span class="n">step_reject</span>
      <span class="p">);</span>

<span class="c1">// Now the vanilla flow where we just add the step to display the nonce.</span>
<span class="n">UX_FLOW</span><span class="p">(</span><span class="n">ux_vanilla_nonce_transaction_signature</span><span class="p">,</span>
         <span class="o">&amp;</span><span class="n">step_review</span><span class="p">,</span>
         <span class="o">&amp;</span><span class="n">step_amount</span><span class="p">,</span>
         <span class="o">&amp;</span><span class="n">step_fee</span><span class="p">,</span>
         <span class="o">&amp;</span><span class="n">step_address</span><span class="p">,</span>
         <span class="o">&amp;</span><span class="n">step_nonce</span><span class="p">,</span> <span class="c1">// Nonce</span>
         <span class="o">&amp;</span><span class="n">step_accept</span><span class="p">,</span>
         <span class="o">&amp;</span><span class="n">step_reject</span>
      <span class="p">);</span>

<span class="c1">// This is identical to the previous example, where we signed some arbitrary data.</span>
<span class="n">UX_FLOW</span><span class="p">(</span><span class="n">ux_data_transaction_signature</span><span class="p">,</span>
         <span class="o">&amp;</span><span class="n">step_review</span><span class="p">,</span>
         <span class="o">&amp;</span><span class="n">step_amount</span><span class="p">,</span>
         <span class="o">&amp;</span><span class="n">step_fee</span><span class="p">,</span>
         <span class="o">&amp;</span><span class="n">step_address</span><span class="p">,</span>
         <span class="o">&amp;</span><span class="n">step_arbitrary_data</span><span class="p">,</span> <span class="c1">// Arbitrary data</span>
         <span class="o">&amp;</span><span class="n">step_accept</span><span class="p">,</span>
         <span class="o">&amp;</span><span class="n">step_reject</span>
      <span class="p">);</span>

<span class="c1">// This is identical to the flow just above, except we add a step to display the nonce.</span>
<span class="n">UX_FLOW</span><span class="p">(</span><span class="n">ux_data_nonce_transaction_signature</span><span class="p">,</span>
         <span class="o">&amp;</span><span class="n">step_review</span><span class="p">,</span>
         <span class="o">&amp;</span><span class="n">step_amount</span><span class="p">,</span>
         <span class="o">&amp;</span><span class="n">step_fee</span><span class="p">,</span>
         <span class="o">&amp;</span><span class="n">step_address</span><span class="p">,</span>
         <span class="o">&amp;</span><span class="n">step_arbitrary_data</span><span class="p">,</span> <span class="c1">// Arbitrary data</span>
         <span class="o">&amp;</span><span class="n">step_nonce</span><span class="p">,</span> <span class="c1">// Nonce</span>
         <span class="o">&amp;</span><span class="n">step_accept</span><span class="p">,</span>
         <span class="o">&amp;</span><span class="n">step_reject</span>
      <span class="p">);</span>
</code></pre></div></div>

<p>And now somewhere in our app at runtime we’re able to decide which flow
to use:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">launch_flow</span><span class="p">()</span> <span class="p">{</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">g</span><span class="p">.</span><span class="n">has_arbitrary_data</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">g</span><span class="p">.</span><span class="n">display_nonce</span><span class="p">)</span> <span class="p">{</span>
         <span class="n">ux_flow_init</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ux_data_nonce_transaction_signature</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
         <span class="n">ux_flow_init</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ux_data_transaction_signature</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
      <span class="p">}</span>
   <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">g</span><span class="p">.</span><span class="n">display_nonce</span><span class="p">)</span> <span class="p">{</span>
         <span class="n">ux_flow_init</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ux_vanilla_nonce_transaction_signature</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
         <span class="n">ux_flow_init</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ux_vanilla_transaction_signature</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
      <span class="p">}</span>
   <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Ugh. Ok now everyone’s happy: we’ve updated our app to support the
protocol and the advanced users in the community can display the nonce.
But now a new upgrade to the protocol is planned for the near future:
the fees can sometimes be paid by another user of the blockchain, called
a relayer. Anyways now some transactions now need to <strong>hide</strong> the fees
(displaying a fee of 0.000 is not an option because it would confuse
users more than anything).</p>

<p>So we need… <strong>8 different flows</strong>. That escalated quickly! Indeed, for
every little <em>upgrade</em>, we’re doubling the number of flows. Soon enough
we’ll end up with 16 or even 32 different flows… Notice that whilst
the number of flows will grow exponentially, the number of different
steps though will only grow linearly (one for every new feature).</p>

<p>To fix this problem, we would need to define the UX_FLOW at runtime,
cherry-picking which steps we wish to include depending on the details
of our transaction.</p>

<p>Don’t worry, Ledger’s got your back! The fix is quite simple, so let’s
dive right into it!</p>

<h4 id="cherry-picking-explained">Cherry-picking explained</h4>

<p>The idea is to create an array of steps that would be big enough to fit
all the steps. Since steps grow linearly, this array won’t be too big.
Once this array created, we simply need to fill it with the steps we
wish to include. Finally, we need to add a last step <code class="language-plaintext highlighter-rouge">FLOW_END_STEP</code> for
it to work properly.</p>

<p>We can then call the <code class="language-plaintext highlighter-rouge">ux_init_flow</code> and pass in our array as argument!</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// The maximum number of steps we will ever need. Here it's 8: step_review, step_amount,</span>
<span class="c1">// step_fee, step_address, step_arbitrary_data, step_nonce, step_accept, step_reject.</span>
<span class="cp">#define MAX_NUM_STEPS 8
</span>
<span class="c1">// The array of steps. Notice the type used, as it's important if you wish to use ux_init_flow.</span>
<span class="c1">// We're adding `+ 1` because we need to ensure we always have extra room for the last step, FLOW_END_STEP.</span>
<span class="k">const</span> <span class="n">ux_flow_step_t</span> <span class="o">*</span><span class="n">ux_signature_flow</span><span class="p">[</span><span class="n">MAX_NUM_STEPS</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
</code></pre></div></div>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">start_display</span><span class="p">()</span> <span class="p">{</span>
   <span class="kt">uint8_t</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

   <span class="c1">// Set the first step to be `step_review`, and then increment `index`.</span>
   <span class="n">ux_signature_flow</span><span class="p">[</span><span class="n">index</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">step_review</span><span class="p">;</span>
   <span class="c1">// Set the second step to be `step_amount`, and then increment `index`.</span>
   <span class="n">ux_signature_flow</span><span class="p">[</span><span class="n">index</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">step_amount</span><span class="p">;</span>
   <span class="c1">// etc...</span>
   <span class="n">ux_signature_flow</span><span class="p">[</span><span class="n">index</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">step_fee</span><span class="p">;</span>
   <span class="n">ux_signature_flow</span><span class="p">[</span><span class="n">index</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">step_address</span><span class="p">;</span>
   <span class="c1">// We can now conditionally add steps at runtime!</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">g</span><span class="p">.</span><span class="n">has_arbitrary_data</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">ux_signature_flow</span><span class="p">[</span><span class="n">index</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">step_arbitrary_data</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="k">if</span> <span class="p">(</span><span class="n">g</span><span class="p">.</span><span class="n">display_nonce</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">ux_signature_flow</span><span class="p">[</span><span class="n">index</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">step_nonce</span><span class="p">;</span>
   <span class="p">}</span>
   <span class="n">ux_signature_flow</span><span class="p">[</span><span class="n">index</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">step_accept</span><span class="p">;</span>
   <span class="n">ux_signature_flow</span><span class="p">[</span><span class="n">index</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">step_reject</span><span class="p">;</span>

   <span class="c1">// Don't forget to finish your flow with this special step.</span>
   <span class="n">ux_signature_flow</span><span class="p">[</span><span class="n">index</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">FLOW_END_STEP</span><span class="p">;</span>

   <span class="c1">// Start the display!</span>
   <span class="n">ux_init_flow</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ux_signature_flow</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<h3 id="defining-steps-at-runtime">Defining steps at runtime</h3>

<p>In the previous section we saw that we could define a <code class="language-plaintext highlighter-rouge">UX_FLOW</code> at
runtime. But we did this whilst still having steps defined statically.
What if we wish to define steps at runtime too? This would give us a
very fine-grained control over what we wish to display, without having
to declare a step everytime.</p>

<p>Finding a step that would be generic enough to fit all our needs.
Naively, the code we’d expect would look something like that:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Naive definition of a UX_FLOW.</span>
<span class="c1">// Note: we are still keeping step_review, step_accept and</span>
<span class="c1">// step_reject because we know our flow will need those anyway.</span>
<span class="n">UX_FLOW</span><span class="p">(</span><span class="n">ideal_dynamic_fow</span><span class="p">,</span>
         <span class="o">&amp;</span><span class="n">step_welcome</span><span class="p">,</span>
         <span class="o">&amp;</span><span class="n">step_generic</span><span class="p">,</span> <span class="c1">// A generic step that would fit all our needs.</span>
         <span class="o">&amp;</span><span class="n">step_quit</span>
         <span class="n">FLOW_LOOP</span>
   <span class="p">);</span>
</code></pre></div></div>

<p>However this wouldn’t work: if we only defined a single step, then how
could it dynamically change its information? Pressing the right button
would make it loop and we’d end up on the same exact screen, and
pressing the left button would lead to the same situation.</p>

<p>So here’s a solution:</p>

<ul>
  <li>Add an extra step just before the <code class="language-plaintext highlighter-rouge">step_generic</code> step, and another
one right after it.</li>
  <li>Those extra steps are nothing but delimiters for the <code class="language-plaintext highlighter-rouge">step_generic</code>
. They allow us to execute special logic to update the screen and
redisplay it. They also allow us to keep track of an index, so that
we know whether we’re still within our array boundaries or not.</li>
</ul>

<p>Here’s what the code looks like.</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">UX_FLOW</span><span class="p">(</span><span class="n">dynamic_flow</span><span class="p">,</span>
         <span class="o">&amp;</span><span class="n">step_welcome</span><span class="p">,</span>

         <span class="o">&amp;</span><span class="n">step_upper_delimiter</span><span class="p">,</span> <span class="c1">// A special step that serves as the upper delimiter. It won't print anything on the screen.</span>
         <span class="o">&amp;</span><span class="n">step_generic</span><span class="p">,</span> <span class="c1">// Our generic step that will actually display stuff on the screen.</span>
         <span class="o">&amp;</span><span class="n">step_lower_delimiter</span><span class="p">,</span> <span class="c1">// A special step that serves as the lower delimiter. It won't print anything on the screen.</span>

         <span class="o">&amp;</span><span class="n">step_quit</span><span class="p">,</span>
         <span class="n">FLOW_LOOP</span>
   <span class="p">);</span>
</code></pre></div></div>

<p>The definition of <code class="language-plaintext highlighter-rouge">step_upper_delimiter</code>, <code class="language-plaintext highlighter-rouge">step_lower_delimiter</code> and
<code class="language-plaintext highlighter-rouge">step_generic</code> could look like this:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// Note we're using UX_STEP_INIT because this step won't display anything.</span>
<span class="n">UX_STEP_INIT</span><span class="p">(</span>
   <span class="n">step_upper_delimiter</span><span class="p">,</span>
   <span class="nb">NULL</span><span class="p">,</span>
   <span class="nb">NULL</span><span class="p">,</span>
   <span class="p">{</span>
      <span class="c1">// This function will be detailed later on.</span>
      <span class="n">display_next_state</span><span class="p">(</span><span class="nb">true</span><span class="p">);</span>
   <span class="p">}</span>
<span class="p">);</span>

<span class="n">UX_STEP_NOCB</span><span class="p">(</span>
   <span class="n">step_generic</span><span class="p">,</span>
   <span class="n">bnnn_paging</span><span class="p">,</span>
   <span class="p">{</span>
      <span class="p">.</span><span class="n">title</span> <span class="o">=</span> <span class="n">global</span><span class="p">.</span><span class="n">title</span><span class="p">,</span>
      <span class="p">.</span><span class="n">text</span> <span class="o">=</span> <span class="n">global</span><span class="p">.</span><span class="n">text</span><span class="p">,</span>
   <span class="p">}</span>
<span class="p">);</span>

<span class="c1">// Note we're using UX_STEP_INIT because this step won't display anything.</span>
<span class="n">UX_STEP_INIT</span><span class="p">(</span>
   <span class="n">step_lower_delimiter</span><span class="p">,</span>
   <span class="nb">NULL</span><span class="p">,</span>
   <span class="nb">NULL</span><span class="p">,</span>
   <span class="p">{</span>
      <span class="c1">// This function will be detailed later on.</span>
      <span class="n">display_next_state</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>
   <span class="p">}</span>
<span class="p">);</span>
</code></pre></div></div>

<p>As you can see, <code class="language-plaintext highlighter-rouge">step_upper_delimiter</code> and <code class="language-plaintext highlighter-rouge">step_lower_delimiter</code> are
very similar. <code class="language-plaintext highlighter-rouge">step_generic</code> is a simple <code class="language-plaintext highlighter-rouge">bnnn_paging</code> that will always
display what’s located in <code class="language-plaintext highlighter-rouge">global.title</code> and <code class="language-plaintext highlighter-rouge">global.text</code>.</p>

<p>And now we only need to implement the special logic for this to work!</p>

<p>Inside the <code class="language-plaintext highlighter-rouge">.h</code> file, we only need to add an enum definition and an
instance of this enum in our global structure:</p>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// State of the dynamic display.</span>
<span class="c1">// Use to keep track of whether we are displaying screens that are inside the </span>
<span class="c1">// array (dynamic), or outside the array (static).</span>
<span class="k">enum</span> <span class="n">e_state</span> <span class="p">{</span>
   <span class="n">STATIC_SCREEN</span><span class="p">,</span>
   <span class="n">DYNAMIC_SCREEN</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">global</span> <span class="p">{</span>
   <span class="c1">// An instance of our new enum</span>
   <span class="k">enum</span> <span class="n">e_state</span> <span class="n">current_state</span><span class="p">;</span>

   <span class="c1">// The rest of the global stays unchanged...</span>
<span class="p">}</span>
</code></pre></div></div>

<p>And in the <code class="language-plaintext highlighter-rouge">.c</code> file, we add all the business logic. A helper function</p>

<p>is used throughout the code. This function is yours to define, and
basically fills the title_buffer and the text_buffer with the
appropriate strings. Is returns a <code class="language-plaintext highlighter-rouge">bool</code> corresponding to whether or not
it found data to fill the buffers. The <span class="title-ref">:code:`bool forward</span> parameter is used to
indicate whether we wish to display the next screen or the previous
screen.</p>

<blockquote>
  <p>The code is commented thoroughly, so take your time and read it
carefully.</p>
</blockquote>

<div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// This is a special function we must call for bnnn_paging to work properly in an edgecase.</span>
<span class="c1">// It does some weird stuff with the `G_ux` global which is defined by the SDK.</span>
<span class="c1">// No need to dig deeper into the code, a simple copy paste will do.</span>
<span class="kt">void</span> <span class="nf">bnnn_paging_edgecase</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">G_ux</span><span class="p">.</span><span class="n">flow_stack</span><span class="p">[</span><span class="n">G_ux</span><span class="p">.</span><span class="n">stack_count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">prev_index</span> <span class="o">=</span> <span class="n">G_ux</span><span class="p">.</span><span class="n">flow_stack</span><span class="p">[</span><span class="n">G_ux</span><span class="p">.</span><span class="n">stack_count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">index</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span>
    <span class="n">G_ux</span><span class="p">.</span><span class="n">flow_stack</span><span class="p">[</span><span class="n">G_ux</span><span class="p">.</span><span class="n">stack_count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">index</span><span class="o">--</span><span class="p">;</span>
    <span class="n">ux_flow_relayout</span><span class="p">();</span>
<span class="p">}</span>

<span class="c1">// Main function that handles all the business logic for our new display architecture.</span>
<span class="kt">void</span> <span class="nf">display_next_state</span><span class="p">(</span><span class="n">bool</span> <span class="n">is_upper_delimiter</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">is_upper_delimiter</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// We're called from the upper delimiter.</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">global</span><span class="p">.</span><span class="n">current_state</span> <span class="o">==</span> <span class="n">STATIC_SCREEN</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// Fetch new data.</span>
            <span class="n">bool</span> <span class="n">dynamic_data</span> <span class="o">=</span> <span class="n">get_next_data</span><span class="p">(</span><span class="o">&amp;</span><span class="n">global</span><span class="p">.</span><span class="n">title</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">global</span><span class="p">.</span><span class="n">text</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">dynamic_data</span><span class="p">)</span> <span class="p">{</span>
                <span class="c1">// We found some data to display so we now enter in dynamic mode.</span>
                <span class="n">global</span><span class="p">.</span><span class="n">current_state</span> <span class="o">=</span> <span class="n">DYNAMIC_SCREEN</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="c1">// Move to the next step, which will display the screen.</span>
            <span class="n">ux_flow_next</span><span class="p">();</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="c1">// The previous screen was NOT a static screen, so we were already in a dynamic screen.</span>

            <span class="c1">// Fetch new data.</span>
            <span class="n">bool</span> <span class="n">dynamic_data</span> <span class="o">=</span> <span class="n">get_next_data</span><span class="p">(</span><span class="o">&amp;</span><span class="n">global</span><span class="p">.</span><span class="n">title</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">globa</span><span class="p">.</span><span class="n">text</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">dynamic_data</span><span class="p">)</span> <span class="p">{</span>
                <span class="c1">// We found some data so simply display it.</span>
                <span class="n">ux_flow_next</span><span class="p">();</span>
            <span class="p">}</span>
            <span class="k">else</span> <span class="p">{</span>
                <span class="c1">// There's no more dynamic data to display, so </span>
                <span class="c1">// update the current state accordingly.</span>
                <span class="n">global</span><span class="p">.</span><span class="n">current_state</span> <span class="o">=</span> <span class="n">STATIC_SCREEN</span><span class="p">;</span>

                <span class="c1">// Display the previous screen which should be a static one.</span>
                <span class="n">ux_flow_prev</span><span class="p">();</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="c1">// We're called from the lower delimiter.</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">global</span><span class="p">.</span><span class="n">current_state</span> <span class="o">==</span> <span class="n">STATIC_SCREEN</span><span class="p">)</span> <span class="p">{</span>
                <span class="c1">// Fetch new data.</span>
                <span class="n">bool</span> <span class="n">dynamic_data</span> <span class="o">=</span> <span class="n">get_next_data</span><span class="p">(</span><span class="o">&amp;</span><span class="n">global</span><span class="p">.</span><span class="n">title</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">global</span><span class="p">.</span><span class="n">text</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">dynamic_data</span><span class="p">)</span> <span class="p">{</span>
                    <span class="c1">// We found some data to display so enter in dynamic mode.</span>
                    <span class="n">global</span><span class="p">.</span><span class="n">current_state</span> <span class="o">=</span> <span class="n">DYNAMIC_SCREEN</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="c1">// Display the data.</span>
                <span class="n">ux_flow_prev</span><span class="p">();</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="c1">// We're being called from a dynamic screen, so the user was already browsing the array.</span>

                <span class="c1">// Fetch new data.</span>
                <span class="n">bool</span> <span class="n">dynamic_data</span> <span class="o">=</span> <span class="n">get_next_data</span><span class="p">(</span><span class="o">&amp;</span><span class="n">global</span><span class="p">.</span><span class="n">title</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">global</span><span class="p">.</span><span class="n">text</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">dynamic_data</span><span class="p">)</span> <span class="p">{</span>
                    <span class="c1">// We found some data, so display it.</span>
                    <span class="c1">// Similar to `ux_flow_prev()` but updates layout to account for `bnnn_paging`'s weird behaviour.</span>
                    <span class="n">bnnn_paging_edgecase</span><span class="p">();</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="c1">// We found no data so make sure we update the state accordingly.</span>
                    <span class="n">global</span><span class="p">.</span><span class="n">current_state</span> <span class="o">=</span> <span class="n">STATIC_SCREEN</span><span class="p">;</span>

                    <span class="c1">// Display the next screen</span>
                    <span class="n">ux_flow_next</span><span class="p">();</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>That was a mouthful! But we did it: we managed to dynamically adapt our
flow AND our steps!</p>


                        
                            <!-- FC
                            <div class="share uk-text-center uk-margin-medium-top">
    
        <a class="uk-link-muted" href="https://twitter.com/intent/tweet?text=Advanced display management&url=http://localhost:4000/docs/NA/u_advanced_display_management/&via=&related=" rel="nofollow" target="_blank" title="Share on Twitter" onclick="window.open(this.href, 'twitter', 'width=550,height=235');return false;"><span data-uk-icon="icon: twitter; ratio: 1.2"></span></a>
    
    
        <a class="uk-link-muted uk-margin-small-left" href="https://www.facebook.com/sharer/sharer.php?u=http%3A%2F%2Flocalhost%3A4000%2Fdocs%2FNA%2Fu_advanced_display_management%2F" rel="nofollow" target="_blank" title="Share on Facebook" onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;"><span data-uk-icon="icon: facebook; ratio: 1.2"></span></a>
    
</div>
                            -->
                        
                    </div>

                    

                    <hr class="uk-margin-medium">

                    


  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  



                    <div class="uk-margin-large-top">
    <h3>Related Docs</h3>

    
    
    

    <ul class="uk-list link-secondary">
    

    
    

    

    

    

    
    

    

    

    

    
    

    

    

    

    
    

    

    

    

    
    

    

    

    

    
    

    

    

    

    
    

    

    

    

    
    

    

    

    

    
    

    

    

    

    
    

    

    

    

    
    

    

    

    

    
    

    

    

    

    
    

    

    

    

    
    

    

    

    

    
    

    

    

    

    
    

    

    

    

    
    

    

    

    

    
    

    

    

    

    
    

    

    

    

    
    

    

    

    

    
    

    

    

    

    
    

    

    

    

    
    

    

    

    

    
    

    

    

    

    
    

    

    

    

    
    

    

    

    

    
    

    

    

    

    
    

    

    

    

    
    

    

    

    

    
    

    

    

    

    
    

    

    

    

    
    

    

    

    

    
    

    

    

    

    
    

    

    

    

    
    

    

    

    

    
    

    

    

    

    
    

    

    

    

    
    

    

    

    

    
    

    

    

    

    
    

    

    

    

    
    

    

    

    

    
    

    

    

    

    
    

    

    

    

    
    

    

    

    

    
    

    

    

    

    
    

    

    

    

    
    

    

    

    

    
    

    

    

    

    
    

    

    

    

    
    

    

    

    

    
    

    

    

    

    
    

    

    

    

    
    

    

    

    

    
    

    

    

    

    
    

    

    

    

    
    

    

    

    

    
    

    

    

    

    
    

    

    

    

    
    

    

    

    

    
    

    

    

    

    
    

    

    

    

    
    

    

    

    

    
    

    

    

    

    
    

    

    

    

    
    

    

    

    

    
    

    

    

    

    
    

    

    

    

    
    

    

    

    

    
    

    

    

    

    
    

    

    

    

    
    

    

    

    

    
    

    

    

    

    
    

    

    

    

    
    

    

    

    

    
    

    

    

    

    
    

    

    

    

    
    

    

    

    

    
    

    

    

    

    
    

    

    

    

    
    

    

    

    

    
    

    

    

    

    
    

    

    

    

    
    

    

    

    

    
    

    

    

    

    
    

    

    

    

    
    

    

    

    

    
    

    

    

    

    
    

    

    

    

    
    

    

    

    

    
    

    

    

    
    </ul>
</div>


                    
                </article>

                <script>
                    // Table of contents scroll to
                    UIkit.scroll('#markdown-toc a', {
                        duration: 400,
                        offset: 120
                    });
                </script>

            </div>

    </div>
</div>


    <div id="offcanvas-docs" data-uk-offcanvas="overlay: true">
    <div class="uk-offcanvas-bar">

        <button class="uk-offcanvas-close" type="button" data-uk-close></button>

        
        <h5 class="uk-margin-top">Getting Started</h5>
        <ul class="uk-nav uk-nav-default doc-nav">
        
          
          
          <li class=""><a href="/docs/TMPL/installation/">Theme installation</a></li>
        
          
          
          <li class=""><a href="/docs/TMPL/setup/">Basic theme setup</a></li>
        
          
          
          <li class=""><a href="/docs/TMPL/navigation/">Navigation bar</a></li>
        
          
          
          <li class=""><a href="/docs/TMPL/footer/">Footer options</a></li>
        
          
          
          <li class=""><a href="/docs/TMPL/posts/">Creating your first post in Jekyll</a></li>
        
          
          
          <li class=""><a href="/docs/TMPL/docs/">Creating docs posts</a></li>
        
          
          
          <li class=""><a href="/docs/TMPL/comments/">Enabling comments (via Disqus)</a></li>
        
          
          
          <li class=""><a href="/docs/TMPL/analytics/">Google Analytics</a></li>
        
        </ul>
        
        <h5 class="uk-margin-top">Theme Features</h5>
        <ul class="uk-nav uk-nav-default doc-nav">
        
          
          
          <li class=""><a href="/docs/TMPL/hero/">Hero page header</a></li>
        
          
          
          <li class=""><a href="/docs/TMPL/boxes/">Category boxes section</a></li>
        
          
          
          <li class=""><a href="/docs/TMPL/featured/">Fearured docs section</a></li>
        
          
          
          <li class=""><a href="/docs/TMPL/videos/">Video lightbox boxes section</a></li>
        
          
          
          <li class=""><a href="/docs/TMPL/faq/">Frequently asked questions section</a></li>
        
          
          
          <li class=""><a href="/docs/TMPL/team/">Team members section</a></li>
        
          
          
          <li class=""><a href="/docs/TMPL/cta/">Call to action section</a></li>
        
          
          
          <li class=""><a href="/docs/TMPL/changelog/">Creating a changelog</a></li>
        
          
          
          <li class=""><a href="/docs/TMPL/contact/">Contact form (via FormSpree)</a></li>
        
          
          
          <li class=""><a href="/docs/TMPL/media/">Adding media to post and doc content</a></li>
        
          
          
          <li class=""><a href="/docs/TMPL/toc/">Adding table of contents to docs</a></li>
        
          
          
          <li class=""><a href="/docs/TMPL/alerts/">Adding alerts to content</a></li>
        
        </ul>
        
        <h5 class="uk-margin-top">Customization</h5>
        <ul class="uk-nav uk-nav-default doc-nav">
        
          
          
          <li class=""><a href="/docs/TMPL/translation/">Translation</a></li>
        
          
          
          <li class=""><a href="/docs/TMPL/customize/">Customization</a></li>
        
          
          
          <li class=""><a href="/docs/TMPL/development/">Development</a></li>
        
          
          
          <li class=""><a href="/docs/TMPL/sources/">Sources and credits</a></li>
        
        </ul>
        
        <h5 class="uk-margin-top">Help</h5>
        <ul class="uk-nav uk-nav-default doc-nav">
        
          
          
          <li class=""><a href="/docs/TMPL/support/">Contacting support</a></li>
        
        </ul>
        

    </div>
</div>


    <div id="offcanvas" data-uk-offcanvas="flip: true; overlay: true">
    <div class="uk-offcanvas-bar">

        <a class="uk-logo uk-margin-small-bottom" href="/">Ledger Developer pages</a>
     
        <button class="uk-offcanvas-close" type="button" data-uk-close></button>
      
        <ul class="uk-nav uk-nav-primary uk-margin-top">
            
                

                

                
                    <li><a href="/" >Home</a></li>
                
            
                

                

                
                    <li><a href="/docs/TMPL/installation" >Docs</a></li>
                
            
                

                

                
                    <li><a href="/blog/" >Blog</a></li>
                
            
                

                

                
                    <li><a href="/changelog-timeline/" >Changelog</a></li>
                
            
                

                

                
                    <li><div class="uk-navbar-item"><a class="uk-button uk-button-success" href="/contact/" >Contact</a></div></li>
                
            
        </ul>

        <div class="uk-margin-top uk-text-center">
            <div data-uk-grid class="uk-child-width-auto uk-grid-small uk-flex-center uk-grid">
                
<div class="uk-first-column">
    <a href="https://twitter.com/" data-uk-icon="icon: twitter" class="uk-icon-link uk-icon" target="_blank"></a>
</div>


<div>
    <a href="https://www.facebook.com/" data-uk-icon="icon: facebook" class="uk-icon-link uk-icon" target="_blank"></a>
</div>




<div>
    <a href="https://www.instagram.com/" data-uk-icon="icon: instagram" class="uk-icon-link uk-icon" target="_blank"></a>
</div>





<div>
    <a href="https://vimeo.com/" data-uk-icon="icon: vimeo" class="uk-icon-link uk-icon" target="_blank"></a>
</div>






            </div>
        </div>

    </div>
</div>


    
        <footer class="uk-section uk-text-center uk-text-muted">
    <div class="uk-container uk-container-small">

        <div>
            <ul class="uk-subnav uk-flex-center">
                
                    
                    
                    
                        <li><a href="/" >Home</a></li>
                    
                
                    
                    
                    
                        <li><a href="/blog/" >Blog</a></li>
                    
                
                    
                    
                    
                        <li><a href="/contact/" >Contact</a></li>
                    
                
            </ul>
        </div>
        <div class="uk-margin-medium">
            <div data-uk-grid class="uk-child-width-auto uk-grid-small uk-flex-center uk-grid">
                
                
<div class="uk-first-column">
    <a href="https://twitter.com/" data-uk-icon="icon: twitter" class="uk-icon-link uk-icon" target="_blank"></a>
</div>


<div>
    <a href="https://www.facebook.com/" data-uk-icon="icon: facebook" class="uk-icon-link uk-icon" target="_blank"></a>
</div>




<div>
    <a href="https://www.instagram.com/" data-uk-icon="icon: instagram" class="uk-icon-link uk-icon" target="_blank"></a>
</div>





<div>
    <a href="https://vimeo.com/" data-uk-icon="icon: vimeo" class="uk-icon-link uk-icon" target="_blank"></a>
</div>






                
            </div>
        </div>
        <div class="uk-margin-medium uk-text-small copyright link-secondary">Made by <a href="https://ledger.com/">Ledger</a> France</div>

    </div>
</footer>

    

    

    

    </body>

</html>
